<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Details</title>
  <link rel="icon" href="/images/icon.png" type="image/png" />
  <link rel="shortcut icon" href="/images/icon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/images/icon.png" />
  <link rel="stylesheet" href="index.css" />
  <script src="theme.js"></script>
</head>

<body>
  <header class="site-header">
    <a class="brand" href="/">
      <img src="/images/icon.png" alt="MovieApp" class="brand-icon" />
      <span>Movie<span class="accent">App</span></span>
    </a>
    <nav class="top-nav">
      <div class="menu">
        <button id="menuBtn" class="menu-btn" aria-haspopup="true" aria-expanded="false">
          ☰ Menu
        </button>
        <ul id="menuDropdown" class="dropdown">
          <li><a href="/">Home</a></li>
          <li><a href="/watchlist.html">My Watchlist</a></li>
          <li><a href="/watched.html">Watched</a></li>
          <li><a href="/settings.html">Account Settings</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <main class="hero" style="min-height: auto; padding-top: 90px;">
    <div class="hero-box">
      <div id="content" class="details-content">
        <p>Loading…</p>
      </div>
    </div>
  </main>

  <script>
    // menu
    const menuBtn = document.getElementById("menuBtn");
    const menuDropdown = document.getElementById("menuDropdown");
    menuBtn.addEventListener("click", () => menuDropdown.classList.toggle("open"));
    document.addEventListener("click", (e) => {
      if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
        menuDropdown.classList.remove("open");
      }
    });

    // Auth, Watchlist & Watched
    let currentUser = null;
    let inWatchlist = false;
    let inWatched = false;

    async function checkStatus(imdbID) {
      try {
        const userRes = await fetch("/api/user");
        if (userRes.ok) {
          const userData = await userRes.json();
          currentUser = userData.user;

          // Check if in watchlist
          const listRes = await fetch("/api/watchlist");
          if (listRes.ok) {
            const list = await listRes.json();
            inWatchlist = list.some(m => m.imdb_id === imdbID);
          }

          // Check if in watched
          const wRes = await fetch("/api/watched");
          if (wRes.ok) {
            const wlist = await wRes.json();
            inWatched = wlist.some(m => m.imdb_id === imdbID);
          }
        }
      } catch (err) {
        console.error("Status check failed", err);
      }
    }

    async function toggleWatchlist(movie) {
      if (!currentUser) {
        window.location.href = "/login.html";
        return;
      }

      const action = inWatchlist ? "DELETE" : "POST";
      const url = action === "DELETE" ? `/api/watchlist/${movie.imdbID}` : "/api/watchlist";
      const body = action === "POST" ? JSON.stringify(movie) : null;

      try {
        const res = await fetch(url, {
          method: action,
          headers: { "Content-Type": "application/json" },
          body: body
        });

        if (res.ok) {
          inWatchlist = !inWatchlist;
          updateButton();
        } else {
          alert("Action failed");
        }
      } catch (err) {
        console.error("Toggle failed", err);
      }
    }

    function updateButton() {
      const btn = document.getElementById("wlBtn");
      if (!btn) return;
      btn.textContent = inWatchlist ? "✓ In Watchlist" : "+ Watchlist";
      btn.classList.toggle("active", inWatchlist);
    }

    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const content = document.getElementById("content");

    (async function () {
      await checkStatus(id);

      try {
        const r = await fetch(`/api/details?id=${encodeURIComponent(id)}`);
        if (!r.ok) throw new Error("Failed to load details");
        const m = await r.json();

        const poster = (m.Poster && m.Poster !== "N/A") ? m.Poster : "https://via.placeholder.com/500x750?text=No+Image";

        content.innerHTML = `
            <img src="${poster}" alt="${m.Title}" />
            <div class="details-info">
              <h1>${m.Title} <span style="font-weight:400; color:#a2a9bb;">(${m.Year || ""})</span></h1>
              <p><strong>Genre:</strong> ${m.Genre || "-"}</p>
              <p><strong>Director:</strong> ${m.Director || "-"}</p>
              <p><strong>Actors:</strong> ${m.Actors || "-"}</p>
              <p><strong>IMDb Rating:</strong> ${m.imdbRating || "-"}</p>
              <p><strong>Plot:</strong> ${m.Plot || "-"}</p>

              <div style="display:flex; gap:10px; margin-top:10px;">
                <a href="/" class="details-link back-btn">← Back</a>
                <button id="wlBtn" class="wl-btn">Loading...</button>
                <button id="watchedBtn" class="wl-btn">Loading...</button>
              </div>
            </div>
          `;

        updateButton();

        document.getElementById("wlBtn").addEventListener("click", () => {
          toggleWatchlist({ imdbID: m.imdbID, Title: m.Title, Poster: poster, Year: m.Year || "" });
        });

        // Watched button logic
        const watchedBtn = document.getElementById("watchedBtn");
        if (watchedBtn) {
          function updateWatchedButton() {
            watchedBtn.textContent = inWatched ? "✓ Watched" : "+ Watched";
            watchedBtn.classList.toggle("active", inWatched);
          }

          updateWatchedButton();

          async function toggleWatched(movie) {
            if (!currentUser) {
              window.location.href = "/login.html";
              return;
            }

            if (inWatched) {
              // remove
              try {
                const res = await fetch(`/api/watched/${movie.imdbID}`, { method: "DELETE" });
                if (res.ok) {
                  inWatched = false;
                  updateWatchedButton();
                } else {
                  alert("Action failed");
                }
              } catch (err) {
                console.error("Toggle failed", err);
              }
            } else {
              // prompt for a comment then add
              const comment = prompt("Add an optional comment about this movie:", "");
              try {
                const res = await fetch("/api/watched", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ imdbID: movie.imdbID, Title: movie.Title, Poster: movie.Poster, Year: movie.Year, comment })
                });
                if (res.ok) {
                  inWatched = true;
                  updateWatchedButton();
                } else {
                  alert("Action failed");
                }
              } catch (err) {
                console.error("Toggle failed", err);
              }
            }
          }

          watchedBtn.addEventListener("click", () => {
            toggleWatched({ imdbID: m.imdbID, Title: m.Title, Poster: poster, Year: m.Year || "" });
          });
        }
      } catch (err) {
        content.innerHTML = `<p style="color:red;">${err.message}</p>`;
        console.error(err);
      }
    })();
  </script>
</body>

</html>